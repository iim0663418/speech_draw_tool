<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>發言抽籤工具</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background-color: #f8f9fa;
    }

    /* 按鈕呼吸動畫（改為藍色陰影） */
    @keyframes pulseShadow {
      0% {
        transform: scale(1);
        box-shadow: 0 0 5px rgba(13, 110, 253, 0.5), 0 0 10px rgba(13, 110, 253, 0.5);
      }
      50% {
        transform: scale(1.05);
        box-shadow: 0 0 20px rgba(13, 110, 253, 0.8), 0 0 30px rgba(13, 110, 253, 0.8);
      }
      100% {
        transform: scale(1);
        box-shadow: 0 0 5px rgba(13, 110, 253, 0.5), 0 0 10px rgba(13, 110, 253, 0.5);
      }
    }
    #drawBtn {
      animation: pulseShadow 2s ease-in-out infinite;
    }
    #drawBtn:hover,
    #drawBtn:focus {
      animation-play-state: paused;
    }

    /* 倒數動畫 */
    @keyframes countdownFade {
      0% { opacity: 0; transform: scale(0.8); }
      50% { opacity: 1; transform: scale(1.2); }
      100% { opacity: 0; transform: scale(0.8); }
    }
    .countdown-number {
      font-size: 4rem;
      color: #fff;
      animation: countdownFade 1s ease-in-out;
      position: relative;
      z-index: 2;
      margin-bottom: 1rem;
    }

    /* 遮罩＆模糊 */
    .overlay {
      display: none !important;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }
    .overlay.show {
      display: flex !important;
    }
    .overlay.fade-out {
      animation: overlayFade 1s forwards;
    }
    .blur-bg {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      z-index: 1;
    }
    @keyframes overlayFade {
      0% {
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(10px);
      }
      100% {
        background: rgba(0, 0, 0, 0);
        backdrop-filter: blur(0px);
      }
    }

    /* 螢光邊框動畫 */
    @keyframes glowBorder {
      0% {
        box-shadow: 0 0 5px rgba(13, 110, 253, 0.5), 0 0 10px rgba(13, 110, 253, 0.5);
      }
      50% {
        box-shadow: 0 0 20px rgba(13, 110, 253, 1), 0 0 30px rgba(13, 110, 253, 1);
      }
      100% {
        box-shadow: 0 0 5px rgba(13, 110, 253, 0.5), 0 0 10px rgba(13, 110, 253, 0.5);
      }
    }
    .glow-animation {
      animation: glowBorder 1.5s ease-in-out;
    }

    /* 發言者卡片＆提示文字 */
    .selected-speaker-wrapper {
      position: relative;
      display: inline-block;
      margin-top: 1rem;
      text-align: center;
      z-index: 3;
    }
    .selected-speaker {
      font-size: 3rem;
      font-weight: bold;
      color: #0d6efd;
      background: #e7f1ff;
      padding: 1rem 2rem;
      border-radius: 0.5rem;
      box-shadow: 0 0 5px rgba(13, 110, 253, 0.5), 0 0 10px rgba(13, 110, 253, 0.5);
      animation: popIn 0.8s ease-in-out;
    }
    @keyframes popIn {
      0% { opacity: 0; transform: scale(0.5) rotate(-10deg); }
      60% { opacity: 1; transform: scale(1.2) rotate(5deg); }
      100% { opacity: 1; transform: scale(1) rotate(0deg); }
    }
    .speaker-note {
      margin-top: 0.5rem;
      font-size: 1.25rem;
      color: #6c757d;
      animation: fadeInNote 0.8s ease-in-out;
    }
    @keyframes fadeInNote {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* 已發言順序收合 */
    #spokenContainer {
      max-height: 300px;
      overflow-y: auto;
      transition: max-height 0.3s ease;
    }
    #spokenContainer.collapse {
      max-height: 0;
      overflow: hidden;
    }
    #spokenContainer.collapse.show {
      max-height: 300px;
    }
    #spokenList li {
      margin-bottom: 0.5rem;
    }
    .fadeInList li {
      opacity: 0;
      animation: fadeIn 0.5s ease-in-out forwards;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to   { opacity: 1; }
    }

    /* Toast 位置 */
    .toast-container {
      position: fixed;
      bottom: 0;
      right: 0;
      padding: 1rem;
      z-index: 1100;
    }

    /* RWD for iPad */
    @media (min-width: 768px) and (max-width: 1024px) {
      .selected-speaker {
        font-size: 2.5rem;
      }
      #participants {
        font-size: 1.1rem;
      }
      #drawBtn {
        width: 80%;
      }
    }
    @media (max-width: 575.98px) {
      .d-flex.justify-content-between {
        flex-direction: column;
        align-items: flex-start;
      }
      .d-flex.justify-content-between button {
        margin-top: 0.5rem;
      }
    }
  </style>
</head>
<body>
  <div class="container-fluid py-3">
    <!-- 標題置中 -->
    <div class="row">
      <div class="col-12 text-center mb-4">
        <h1>發言抽籤工具</h1>
      </div>
    </div>

    <!-- 參與者輸入區 -->
    <div class="row justify-content-center">
      <div class="col-lg-6 col-md-8 mb-3">
        <label for="participants" class="form-label">參與者清單（每行一位）：</label>
        <textarea class="form-control" id="participants" rows="8"></textarea>
        <p id="participantCount" class="mt-2 text-muted">目前參與者 0 人</p>
      </div>
    </div>

    <!-- 抽取按鈕置中於全頁 -->
    <div class="d-flex justify-content-center mb-4">
      <button id="drawBtn" class="btn btn-primary btn-lg fw-bold">
        抽取發言者
      </button>
    </div>

    <!-- 當前發言者顯示區 -->
    <div class="row mt-4">
      <div class="col-12 text-center" id="currentSpeakerWrapper"></div>
    </div>

    <!-- 已發言順序與收合／重置按鈕 -->
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>📋 已發言順序</h4>
      <div>
        <button id="toggleListBtn" class="btn btn-outline-secondary btn-sm me-2">收起</button>
        <button id="resetBtn" class="btn btn-outline-secondary btn-sm">重置</button>
      </div>
    </div>
    <div id="spokenContainer" class="collapse show">
      <ul id="spokenList" class="list-group fadeInList"></ul>
    </div>
  </div>

  <!-- Toast 通知 -->
  <div class="toast-container">  
    <div id="resetToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">
          已重置完成
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <!-- 引入 Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let participants = [];
    let spokenOrder = [];

    function loadSpokenOrder() {
      const stored = localStorage.getItem('spokenOrder');
      if (stored) {
        try {
          spokenOrder = JSON.parse(stored);
        } catch {
          spokenOrder = [];
        }
      }
    }

    function saveSpokenOrder() {
      localStorage.setItem('spokenOrder', JSON.stringify(spokenOrder));
    }

    function updateParticipantCount() {
      const list = document.getElementById('participants').value
        .split('\n').map(n => n.trim()).filter(n => n !== '');
      participants = list;
      document.getElementById('participantCount').textContent = '目前參與者 ' + participants.length + ' 人';
    }

    function renderSpokenList() {
      const ul = document.getElementById('spokenList');
      ul.innerHTML = '';
      spokenOrder.forEach((name, index) => {
        const li = document.createElement('li');
        li.className = 'list-group-item';
        li.textContent = (index + 1) + '. ' + name;
        ul.appendChild(li);
      });
    }

    async function showCountdownAnimation() {
      return new Promise(async resolve => {
        const overlay = document.getElementById('overlay');
        const container = document.getElementById('countdownContainer');
        container.innerHTML = '';
        overlay.classList.remove('fade-out');
        overlay.classList.add('show');
        for (let c = 3; c > 0; c--) {
          const div = document.createElement('div');
          div.className = 'countdown-number';
          div.textContent = c;
          container.appendChild(div);
          void div.offsetWidth;
          await new Promise(r => setTimeout(r, 1000));
          container.removeChild(div);
        }
        overlay.classList.add('fade-out');
        setTimeout(() => {
          overlay.classList.remove('show', 'fade-out');
          resolve();
        }, 1000);
      });
    }

    async function selectSpeaker() {
      const btn = document.getElementById('drawBtn');
      btn.disabled = true;
      btn.textContent = '抽取中…';

      if (participants.length === 0) {
        alert('所有人已發言完畢或請先輸入參與者');
        btn.disabled = false;
        btn.textContent = '抽取發言者';
        return;
      }
      await showCountdownAnimation();

      const idx = Math.floor(Math.random() * participants.length);
      const chosen = participants.splice(idx, 1)[0];
      document.getElementById('participants').value = participants.join('\n');
      updateParticipantCount();

      const wrapper = document.getElementById('currentSpeakerWrapper');
      wrapper.innerHTML = `
        <div class="selected-speaker-wrapper">
          <h2 class="selected-speaker">🎤 ${chosen}</h2>
          <p class="speaker-note">下一位發言者請準備...</p>
        </div>
      `;
      const speakerElem = document.querySelector('.selected-speaker');
      speakerElem.classList.add('glow-animation');
      speakerElem.addEventListener('animationend', () => {
        speakerElem.classList.remove('glow-animation');
      }, { once: true });

      spokenOrder.push(chosen);
      saveSpokenOrder();
      renderSpokenList();

      setTimeout(() => {
        btn.disabled = false;
        btn.textContent = '抽取發言者';
      }, 2000);
    }

    function resetAll() {
      if (confirm('確定要重置所有資料？')) {
        participants = [];
        spokenOrder = [];
        document.getElementById('participants').value = '';
        document.getElementById('currentSpeakerWrapper').innerHTML = '';
        updateParticipantCount();
        localStorage.removeItem('spokenOrder');
        renderSpokenList();
        resetToast.show();
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadSpokenOrder();
      renderSpokenList();
      updateParticipantCount();

      document.getElementById('participants').addEventListener('input', updateParticipantCount);
      document.getElementById('drawBtn').addEventListener('click', selectSpeaker);
      document.getElementById('resetBtn').addEventListener('click', resetAll);

      // 初始化 Toast
      window.resetToast = new bootstrap.Toast(document.getElementById('resetToast'), { delay: 2000 });

      // 初始化 collapse 功能
      const spokenContainer = document.getElementById('spokenContainer');
      new bootstrap.Collapse(spokenContainer, { toggle: false });

      // 綁定收合／展開按鈕
      const toggleBtn = document.getElementById('toggleListBtn');
      toggleBtn.addEventListener('click', () => {
        if (spokenContainer.classList.contains('show')) {
          new bootstrap.Collapse(spokenContainer, { toggle: true });
          toggleBtn.textContent = '展開';
        } else {
          new bootstrap.Collapse(spokenContainer, { toggle: true });
          toggleBtn.textContent = '收起';
        }
      });
    });
  </script>

  <!-- Overlay for countdown and blur -->
  <div id="overlay" class="overlay">
    <div class="blur-bg"></div>
    <div id="countdownContainer"></div>
  </div>
</body>
</html>
